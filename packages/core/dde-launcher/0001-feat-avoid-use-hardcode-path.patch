From 69f25bfb8828feadf5a1845c32223527468fb505 Mon Sep 17 00:00:00 2001
From: rewine <luhongxu@deepin.org>
Date: Mon, 29 May 2023 15:54:14 +0800
Subject: [PATCH] feat: avoid use hardcode path

Log: avoid use hardcode path
---
 CMakeLists.txt                                  | 17 ++++++++++++-----
 dde-launcher-wapper => dde-launcher-wapper.in   |  2 +-
 dde-launcher.desktop => dde-launcher.desktop.in |  2 +-
 .../org.deepin.dde.Launcher1.service            |  3 ---
 .../org.deepin.dde.Launcher1.service.in         |  3 +++
 5 files changed, 17 insertions(+), 10 deletions(-)
 rename dde-launcher-wapper => dde-launcher-wapper.in (63%)
 rename dde-launcher.desktop => dde-launcher.desktop.in (76%)
 delete mode 100644 src/dbusservices/org.deepin.dde.Launcher1.service
 create mode 100644 src/dbusservices/org.deepin.dde.Launcher1.service.in

diff --git a/CMakeLists.txt b/CMakeLists.txt
index 89869810..8d347298 100644
--- a/CMakeLists.txt
+++ b/CMakeLists.txt
@@ -13,7 +13,7 @@ set(CMAKE_CXX_STANDARD 14)
 set(CMAKE_INCLUDE_CURRENT_DIR ON)
 set(CMAKE_AUTOMOC ON)
 set(CMAKE_AUTORCC ON)
-set(CMAKE_CXX_FLAGS "-g -Wall")
+set(CMAKE_CXX_FLAGS "${CMAKE_CXX_FLAGS} -g -Wall")
 
 # 增加安全编译参数
 set(CMAKE_CXX_FLAGS "${CMAKE_CXX_FLAGS} -fstack-protector-all")
@@ -49,10 +49,10 @@ set(BIN_NAME dde-launcher)
 add_subdirectory("plugins")
 
 # Install settings
-include(GNUInstallDirs)
 if (CMAKE_INSTALL_PREFIX_INITIALIZED_TO_DEFAULT)
     set(CMAKE_INSTALL_PREFIX /usr)
 endif ()
+include(GNUInstallDirs)
 
 # Find the library
 find_package(PkgConfig REQUIRED)
@@ -232,11 +232,18 @@ file(GLOB QM_FILES "translations/*.qm")
 install(FILES ${QM_FILES} DESTINATION ${CMAKE_INSTALL_DATADIR}/dde-launcher/translations)
 
 ## desktop file
-install(FILES dde-launcher.desktop DESTINATION ${CMAKE_INSTALL_DATADIR}/applications/)
-install(FILES dde-launcher-wapper DESTINATION ${CMAKE_INSTALL_BINDIR} PERMISSIONS OWNER_READ OWNER_WRITE OWNER_EXECUTE GROUP_READ GROUP_EXECUTE WORLD_READ WORLD_EXECUTE)
+configure_file(${CMAKE_SOURCE_DIR}/dde-launcher.desktop.in ${CMAKE_CURRENT_BINARY_DIR}/dde-launcher.desktop @ONLY)
+configure_file(${CMAKE_SOURCE_DIR}/dde-launcher-wapper.in ${CMAKE_CURRENT_BINARY_DIR}/dde-launcher-wapper @ONLY)
+install(FILES ${CMAKE_CURRENT_BINARY_DIR}/dde-launcher.desktop DESTINATION ${CMAKE_INSTALL_DATADIR}/applications/)
+install(FILES ${CMAKE_CURRENT_BINARY_DIR}/dde-launcher-wapper DESTINATION ${CMAKE_INSTALL_BINDIR} PERMISSIONS OWNER_READ OWNER_WRITE OWNER_EXECUTE GROUP_READ GROUP_EXECUTE WORLD_READ WORLD_EXECUTE)
 
 ## services files
-install(FILES src/dbusservices/org.deepin.dde.Launcher1.service DESTINATION share/dbus-1/services)
+configure_file(
+    ${CMAKE_SOURCE_DIR}/src/dbusservices/org.deepin.dde.Launcher1.service.in
+    ${CMAKE_CURRENT_BINARY_DIR}/org.deepin.dde.Launcher1.service
+    @ONLY)
+install(FILES ${CMAKE_CURRENT_BINARY_DIR}/org.deepin.dde.Launcher1.service 
+	DESTINATION ${CMAKE_INSTALL_DATADIR}/dbus-1/services)
 
 #schemas
 install(FILES gschema/com.deepin.dde.launcher.gschema.xml DESTINATION ${CMAKE_INSTALL_DATADIR}/glib-2.0/schemas)
diff --git a/dde-launcher-wapper b/dde-launcher-wapper.in
similarity index 63%
rename from dde-launcher-wapper
rename to dde-launcher-wapper.in
index 95b2a9d7..b02a6107 100755
--- a/dde-launcher-wapper
+++ b/dde-launcher-wapper.in
@@ -1,4 +1,4 @@
 #!/bin/bash
 # this will launch dde-launcher
 
-dbus-send --print-reply --session --dest=org.deepin.dde.Application1.Manager /org/deepin/dde/Application1/Manager org.deepin.dde.Application1.Manager.Launch string:/usr/share/applications/dde-launcher.desktop
+dbus-send --print-reply --session --dest=org.deepin.dde.Application1.Manager /org/deepin/dde/Application1/Manager org.deepin.dde.Application1.Manager.Launch string:@CMAKE_INSTALL_FULL_DATADIR@/applications/dde-launcher.desktop
diff --git a/dde-launcher.desktop b/dde-launcher.desktop.in
similarity index 76%
rename from dde-launcher.desktop
rename to dde-launcher.desktop.in
index 94ce4105..d513055e 100755
--- a/dde-launcher.desktop
+++ b/dde-launcher.desktop.in
@@ -1,6 +1,6 @@
 [Desktop Entry]
 Comment=Deepin Launcher
-Exec=/usr/bin/dde-launcher
+Exec=@CMAKE_INSTALL_FULL_BINDIR@/dde-launcher
 Name=Deepin Launcher
 OnlyShowIn=''
 Type=Application
diff --git a/src/dbusservices/org.deepin.dde.Launcher1.service b/src/dbusservices/org.deepin.dde.Launcher1.service
deleted file mode 100644
index 2a8654e1..00000000
--- a/src/dbusservices/org.deepin.dde.Launcher1.service
+++ /dev/null
@@ -1,3 +0,0 @@
-[D-BUS Service]
-Name=org.deepin.dde.Launcher1
-Exec=/usr/bin/dde-launcher-wapper
diff --git a/src/dbusservices/org.deepin.dde.Launcher1.service.in b/src/dbusservices/org.deepin.dde.Launcher1.service.in
new file mode 100644
index 00000000..11a5bfbc
--- /dev/null
+++ b/src/dbusservices/org.deepin.dde.Launcher1.service.in
@@ -0,0 +1,3 @@
+[D-BUS Service]
+Name=org.deepin.dde.Launcher1
+Exec=@CMAKE_INSTALL_FULL_BINDIR@/dde-launcher-wapper
-- 
2.40.1

